const user_to_name = {
  tjm995: "Tessa",
  johulia: "Jojo",
  sammybat: "Sam",
  Sittinduck57: "Alex",
  niranjanravi: "Nir",
  yojek: "Brenna",
  Zoe: "Zoe",
  tim995: "Tessa",
  Jujubeeaa: "Juliet",
  jbg22: "Jerry",
};

const ratings = [
  {
    movie_name: "Game Night",
    reviews: [
      {
        user: "tjm995",
        rating: 4,
        liked: false,
      },
      {
        user: "johulia",
        rating: 3.5,
        liked: false,
      },
      {
        user: "sammybat",
        rating: 3,
        liked: false,
      },
      {
        user: "kachi",
        rating: 5,
        liked: true,
      },
      {
        user: "Aaron",
        rating: 4.5,
        liked: true,
      },
      {
        user: "Sittinduck57",
        rating: 4.5,
        liked: true,
      },
      {
        user: "niranjanravi",
        rating: 4.5,
        liked: true,
      },
      {
        user: "jbg22",
        rating: 3,
        liked: true,
      },
    ],
  },
  {
    movie_name: "Before Sunrise",
    reviews: [
      {
        user: "kachi",
        rating: 5,
        liked: false,
      },
      {
        user: "tjm995",
        rating: 3,
        liked: false,
      },
      {
        user: "sammybat",
        rating: 3.5,
        liked: false,
      },
      {
        user: "niranjanravi",
        rating: 4,
        liked: false,
      },
      {
        user: "johulia",
        rating: 3,
        liked: false,
      },
      {
        user: "yojek",
        rating: 0,
        liked: false,
      },
      {
        user: "rockright",
        rating: 3,
        liked: false,
      },
      {
        user: "Sittinduck57",
        rating: 4,
        liked: false,
      },
      {
        user: "clarasite (2019, dir bong joon-ho)",
        rating: 0,
        liked: false,
      },
      {
        user: "jbg22",
        rating: 2,
        liked: false,
      },
    ],
  },
  {
    movie_name: "The Grand Budapest Hotel",
    reviews: [
      {
        user: "Zoe",
        rating: 0,
        liked: true,
      },
      {
        user: "yojek",
        rating: 4,
        liked: false,
      },
      {
        user: "johulia",
        rating: 3,
        liked: false,
      },
      {
        user: "tjm995",
        rating: 5,
        liked: false,
      },
      {
        user: "niranjanravi",
        rating: 4,
        liked: true,
      },
      {
        user: "sammybat",
        rating: 4,
        liked: false,
      },
      {
        user: "Sittinduck57",
        rating: 5,
        liked: true,
      },
      {
        user: "jbg22",
        rating: 5,
        liked: true,
      },
    ],
  },
  {
    movie_name: "Tag",
    reviews: [
      {
        user: "yojek",
        rating: 3,
        liked: false,
      },
      {
        user: "johulia",
        rating: 3.5,
        liked: false,
      },
      {
        user: "tjm995",
        rating: 3,
        liked: false,
      },
      {
        user: "sammybat",
        rating: 3,
        liked: false,
      },
      {
        user: "Sittinduck57",
        rating: 4,
        liked: false,
      },
      {
        user: "niranjanravi",
        rating: 3,
        liked: false,
      },
      {
        user: "jbg22",
        rating: 2.5,
        liked: true,
      },
    ],
  },
  {
    movie_name: "The Truman Show",
    reviews: [
      {
        user: "CV89",
        rating: 0,
        liked: false,
      },
      {
        user: "Zoe",
        rating: 0,
        liked: true,
      },
      {
        user: "yojek",
        rating: 4,
        liked: false,
      },
      {
        user: "Sittinduck57",
        rating: 4,
        liked: true,
      },
      {
        user: "niranjanravi",
        rating: 4.5,
        liked: true,
      },
      {
        user: "sammybat",
        rating: 3,
        liked: false,
      },
      {
        user: "jbg22",
        rating: 2.5,
        liked: false,
      },
    ],
  },
  {
    movie_name: "The Matrix",
    reviews: [
      {
        user: "CV89",
        rating: 0,
        liked: true,
      },
      {
        user: "tim995",
        rating: 4,
        liked: false,
      },
      {
        user: "yojek",
        rating: 4,
        liked: false,
      },
      {
        user: "Zoe",
        rating: 0,
        liked: false,
      },
      {
        user: "sammybat",
        rating: 3.5,
        liked: false,
      },
      {
        user: "johulia",
        rating: 3.5,
        liked: false,
      },
      {
        user: "niranjanravi",
        rating: 3.5,
        liked: true,
      },
      {
        user: "Jerry",
        rating: 5,
        liked: true,
      },
      {
        user: "rockright",
        rating: 4,
        liked: false,
      },
      {
        user: "Sittinduck57",
        rating: 4.5,
        liked: true,
      },
      {
        user: "jbg22",
        rating: 4.5,
        liked: true,
      },
    ],
  },
  {
    movie_name: "What We Do in the Shadows",
    reviews: [
      {
        user: "CV89",
        rating: 0,
        liked: false,
      },
      {
        user: "tjm995",
        rating: 4,
        liked: true,
      },
      {
        user: "yojek",
        rating: 3.5,
        liked: false,
      },
      {
        user: "Zoe",
        rating: 4.5,
        liked: true,
      },
      {
        user: "johulia",
        rating: 4,
        liked: false,
      },
      {
        user: "Sittinduck57",
        rating: 3.5,
        liked: false,
      },
      {
        user: "jbg22",
        rating: 3,
        liked: false,
      },
    ],
  },
  {
    movie_name: "Wolfwalkers",
    reviews: [
      {
        user: "tjm995",
        rating: 4,
        liked: false,
      },
      {
        user: "johulia",
        rating: 4,
        liked: false,
      },
      {
        user: "niranjanravi",
        rating: 4.5,
        liked: true,
      },
      {
        user: "Sittinduck57",
        rating: 4,
        liked: true,
      },
      {
        user: "sammybat",
        rating: 3.5,
        liked: false,
      },
      {
        user: "Zoe",
        rating: 4.5,
        liked: true,
      },
      {
        user: "Jujubeeaa",
        rating: 5,
        liked: false,
      },
      {
        user: "jbg22",
        rating: 3,
        liked: false,
      },
    ],
  },
  {
    movie_name: "Tetris",
    reviews: [
      {
        user: "yojek",
        rating: 2,
        liked: false,
      },
      {
        user: "Zoe",
        rating: 4,
        liked: true,
      },
      {
        user: "Sittinduck57",
        rating: 2.5,
        liked: false,
      },
      {
        user: "niranjanravi",
        rating: 2,
        liked: false,
      },
      {
        user: "johulia",
        rating: 2.5,
        liked: false,
      },
      {
        user: "jbg22",
        rating: 3.5,
        liked: true,
      },
    ],
  },
  {
    movie_name: "Escape from New York",
    reviews: [
      {
        user: "yojek",
        rating: 2.5,
        liked: false,
      },
      {
        user: "Zoe",
        rating: 2.5,
        liked: false,
      },
      {
        user: "johulia",
        rating: 2,
        liked: false,
      },
      {
        user: "niranjanravi",
        rating: 3,
        liked: true,
      },
      {
        user: "sammybat",
        rating: 0.5,
        liked: false,
      },
      {
        user: "rockright",
        rating: 2.5,
        liked: false,
      },
      {
        user: "Sittinduck57",
        rating: 3.5,
        liked: false,
      },
      {
        user: "jbg22",
        rating: 2,
        liked: false,
      },
    ],
  },
  {
    movie_name: "The Big Short",
    reviews: [
      {
        user: "CV89",
        rating: 0,
        liked: false,
      },
      {
        user: "Zoe",
        rating: 2,
        liked: false,
      },
      {
        user: "sammybat",
        rating: 4.5,
        liked: false,
      },
      {
        user: "johulia",
        rating: 4.5,
        liked: true,
      },
      {
        user: "Sittinduck57",
        rating: 4.5,
        liked: false,
      },
      {
        user: "niranjanravi",
        rating: 4,
        liked: false,
      },
      {
        user: "Aaron",
        rating: 4.5,
        liked: true,
      },
      {
        user: "jbg22",
        rating: 3.5,
        liked: true,
      },
    ],
  },
  {
    movie_name: "Hedda",
    reviews: [
      {
        user: "Sittinduck57",
        rating: 3.5,
        liked: false,
      },
      {
        user: "johulia",
        rating: 4,
        liked: false,
      },
      {
        user: "niranjanravi",
        rating: 4,
        liked: true,
      },
      {
        user: "sammybat",
        rating: 4,
        liked: false,
      },
      {
        user: "Jujubeeaa",
        rating: 5,
        liked: true,
      },
      {
        user: "yojek",
        rating: 5,
        liked: true,
      },
      {
        user: "jbg22",
        rating: 4,
        liked: true,
      },
    ],
  },
];

// Helper function to get all valid reviews with calculated scores
const getValidReviews = (ratings, user_to_name) => {
  const validReviews = [];

  ratings.forEach((movie) => {
    movie.reviews.forEach((review) => {
      // Filter: rating > 0 AND user in user_to_name
      if (review.rating > 0 && review.user in user_to_name) {
        const score = review.rating * (review.liked ? 1.2 : 1);
        validReviews.push({
          movieName: movie.movie_name,
          user: review.user,
          displayName: user_to_name[review.user],
          rating: review.rating,
          liked: review.liked,
          score: score,
        });
      }
    });
  });

  return validReviews;
};

// Calculate metrics for each movie
const calculateMovieMetrics = (validReviews) => {
  const movieMap = {};

  validReviews.forEach((review) => {
    if (!movieMap[review.movieName]) {
      movieMap[review.movieName] = {
        movieName: review.movieName,
        scores: [],
        likeCount: 0,
        reviews: [],
      };
    }

    movieMap[review.movieName].scores.push(review.score);
    if (review.liked) {
      movieMap[review.movieName].likeCount++;
    }
    movieMap[review.movieName].reviews.push({
      displayName: review.displayName,
      score: review.score,
      liked: review.liked,
    });
  });

  // Calculate average scores
  const movieMetrics = Object.values(movieMap).map((movie) => {
    const averageScore =
      movie.scores.reduce((sum, score) => sum + score, 0) / movie.scores.length;
    return {
      movieName: movie.movieName,
      averageScore: averageScore,
      likeCount: movie.likeCount,
      totalReviews: movie.scores.length,
      reviews: movie.reviews,
    };
  });

  return movieMetrics;
};

// Calculate most liked movie
const calculateMostLikedMovie = (movieMetrics) => {
  if (movieMetrics.length === 0) return null;

  const mostLiked = movieMetrics.reduce((best, current) =>
    current.averageScore > best.averageScore ? current : best
  );

  return mostLiked;
};

// Calculate least liked movie
const calculateLeastLikedMovie = (movieMetrics) => {
  if (movieMetrics.length === 0) return null;

  const leastLiked = movieMetrics.reduce((worst, current) =>
    current.averageScore < worst.averageScore ? current : worst
  );

  return leastLiked;
};

// Calculate each person's most liked movie
const calculatePersonalFavorites = (validReviews, user_to_name) => {
  const userFavorites = {};

  // Group reviews by user
  const userReviews = {};
  validReviews.forEach((review) => {
    if (!userReviews[review.user]) {
      userReviews[review.user] = [];
    }
    userReviews[review.user].push(review);
  });

  // Find highest score for each user
  Object.entries(userReviews).forEach(([user, reviews]) => {
    const favorite = reviews.reduce((best, current) =>
      current.score > best.score ? current : best
    );

    const displayName = user_to_name[user];
    userFavorites[displayName] = {
      movieName: favorite.movieName,
      score: favorite.score,
      liked: favorite.liked,
    };
  });

  return userFavorites;
};

// Main export function
export const calculateRatingsStats = (
  ratingsData = ratings,
  userToName = user_to_name
) => {
  const validReviews = getValidReviews(ratingsData, userToName);
  const movieMetrics = calculateMovieMetrics(validReviews);

  const mostLikedMovie = calculateMostLikedMovie(movieMetrics);
  const leastLikedMovie = calculateLeastLikedMovie(movieMetrics);
  const personalFavorites = calculatePersonalFavorites(
    validReviews,
    userToName
  );

  const movieStats = movieMetrics
    .map((movie) => ({
      movieName: movie.movieName,
      averageScore: movie.averageScore,
      likeCount: movie.likeCount,
      totalReviews: movie.totalReviews,
    }))
    .sort((a, b) => b.averageScore - a.averageScore);

  return {
    mostLikedMovie,
    leastLikedMovie,
    personalFavorites,
    movieStats,
  };
};
